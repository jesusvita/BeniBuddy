{% extends 'base.html' %}
{% block title %}Your Tips - {{ month_name }} {{ year }}{% endblock %}

{% block content %} {# Start of content block #}
<div class="rounded min-h-screen px-1 py-6 bg-gradient-to-b from-neutral-950 to-stone-900 text-white">

  <!-- Header Navigation -->
  <div class="flex flex-wrap px-4 sm:px-8 justify-between items-center gap-2 mb-4">

    <!-- Previous -->
    <a href="{% url 'user_tips' prev_year prev_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">
        <span class="hidden sm:inline">← Previous</span>
        <span class="inline sm:hidden">←</span>
    </a>

    <!-- Month & Totals -->
    <div class="text-center">
      <h2 class="text-2xl font-bold lightPink ">{{ month_name }} {{ year }}</h2>
      <div class="text-sm">
        {# TODO: Update these totals if needed to include cash/hours #}
        <span class="text-green-300 font-medium">Tips: ${{ total_monthly_tip|floatformat:2 }}</span> &nbsp;|&nbsp;
        <span class="text-blue-300 font-medium">Gratuity: ${{ total_monthly_gratuity|floatformat:2 }}</span>
        <br>
        <span class="text-yellow-400 font-medium">Cash: ${{ total_monthly_cash|floatformat:2 }}</span>
    </div>
    </div>

    <!-- Next -->
    <a href="{% url 'user_tips' next_year next_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">
       <span class="hidden sm:inline">Next →</span>
        <span class="inline sm:hidden">→</span>
    </a>
  </div>

  <!-- Weekday Labels -->
  <div class="grid grid-cols-7 text-center font-semibold text-[#93A8AC] mb-2">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
    <div>Thu</div><div>Fri</div><div>Sat</div>
  </div>

  <!-- Calendar Grid -->

  <div class="grid grid-cols-7 sm:grid-cols-7 gap-x-1 gap-y-2 text-sm md:gap-2">
    {% for week in weeks %}

      {% for day in week %}
        <div class="relative transition-transform duration-150 hover:scale-[1.03]">
          {% if day %}
            {% if day.tip %}
            <a href="{% url 'edit_tip' day.tip.id %}"
              data-tip-id="{{ day.tip.id }}"
              class="edit-tip-button block h-14 sm:h-16 rounded-lg bg-white text-gray-700 shadow hover:bg-gray-100 transition cursor-pointer">
              {% else %}
              <a href="{% url 'add_tip' %}?date={{ year }}-{{ month|stringformat:'02d' }}-{{ day.day|stringformat:'02d' }}"
                 data-date="{{ year }}-{{ month|stringformat:'02d' }}-{{ day.day|stringformat:'02d' }}"
                 class="add-tip-button block h-14 sm:h-16 rounded-lg bg-white text-gray-700 shadow hover:bg-gray-100 transition cursor-pointer">
            {% endif %}
                <!-- Date Number -->
                <div class="absolute px-1 text-[0.6rem] sm:text-xs font-semibold">{{ day.day }}</div>

                <!-- Tip Info -->
                
                <div class="flex flex-col justify-center items-end  h-full font-semibold pt-3 px-1 sm:pt-1">
                  {% if day.tip %}
                    <div class="font-sans font-[770] text-green-700 text-[0.55rem] sm:text-xs leading-tight sm:leading-normal tabular-nums">
                        ${{ day.tip.amount }}
                    </div>
                    {% if day.tip.gratuity %}
                      <div class="font-sans font-[700] text-blue-700 text-[0.5rem] sm:text-[0.65rem] leading-tight sm:leading-normal tabular-nums ">
                          ${{ day.tip.gratuity }}
                      </div>
                    {% endif %}
                    
                    {% if day.tip.cash_made > 0 %}
                      <div class="font-sans font-[700] text-yellow-600 text-[0.5rem] sm:text-[0.65rem] leading-tight sm:leading-normal tabular-nums ">
                          ${{ day.tip.cash_made }}
                      </div>
                    {% endif %}
                    {% if day.tip.hours_worked > 0 %}
                      <div class="font-sans font-[700] text-purple-600 text-[0.45rem] sm:text-[0.65rem] leading-tight sm:leading-normal tabular-nums ">
                          Hrs: {{ day.tip.hours_worked }}
                      </div>
                    {% endif %} 
                  {% else %}
                    <div class="text-xs text-gray-400 italic"></div>
                  {% endif %}
                </div>

              </a>
          {% else %}
            <!-- Empty box -->
            <div class="h-14 sm:h-16 rounded-lg bg-[#93A8AC] opacity-30"></div>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- Estimated Paycheck Box -->
  <div class="bg-gray-300 text-[#424B54] p-2 sm:p-4 rounded-lg shadow mt-6 relative text-sm sm:text-base">
    <!-- + Button -->
    <div class="absolute top-2 right-0.5 sm:top-4 sm:right-4">

      <button id="openPayCycleModalBtn" type="button"
         class="bg-[#880808] text-white px-3 py-1 rounded-full hover:bg-red-900 text-sm shadow cursor-pointer">
         +
      </button>
    </div>

    <!-- Paycheck Summary -->
    
    <h3 class="text-sm font-sans font-[770] mb-2">Estimate Paycheck for {{ paycheck_day|date:"m-d" }}</h3>
    <p class="font-sans font-[770] text-green-800 text-lg">Tips: ${{ recent_total_tip|floatformat:2 }}</p>
    <p class="font-sans font-[770] text-blue-800 text-lg">Gratuity: ${{ recent_total_gratuity|floatformat:2 }}</p>
    <p class="font-sans font-[770] text-purple-800 text-lg">Hours: {{ recent_total_hours|floatformat:2 }}</p>
    <p class="font-sans font-[770] text-black text-xl mt-2 font-semibold">Total: ${{ paycheck_total|floatformat:2 }}</p>
  </div>
</div>

<!-- Add Tip Modal -->
<div id="addTipModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
      <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Add Tip</h3>
          <button id="closeModalBtn" type="button" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>

      <form id="addTipForm" method="POST" action="{% url 'add_tip' %}">
          {% csrf_token %}
          <input type="hidden" id="modalTipDate" name="date">

          <!-- TipForm fields -->
          <div class="mb-4">
              <label for="modalTipAmount" class="block text-sm font-medium text-gray-700">Tips:</label>
              <input type="number" step="0.01" name="amount" id="modalTipAmount" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
          </div>
          <div class="mb-4">
              <label for="modalTipGratuity" class="block text-sm font-medium text-gray-700">Gratuity:</label>
              <input type="number" step="0.01" name="gratuity" id="modalTipGratuity" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
          </div>

          <!-- START: New Fields for Add Modal -->
          <div class="mb-4">
              <label for="modalCashMade" class="block text-sm font-medium text-gray-700">Cash:</label>
              <input type="number" step="0.01" name="cash_made" id="modalCashMade" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
          </div>
          <div class="mb-4">
              <label for="modalHoursWorked" class="block text-sm font-medium text-gray-700">Hours Worked:</label>
              <input type="number" step="0.25" name="hours_worked" id="modalHoursWorked" placeholder="0.0" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
          </div>
          <!-- END: New Fields for Add Modal -->

          <div class="mb-4"> {# Added Note field to Add Modal for consistency #}
              <label for="modalTipNote" class="block text-sm font-medium text-gray-700">Note (Optional)</label>
              <textarea name="note" id="modalTipNote" rows="3" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500"></textarea>
          </div>

          <div class="mt-6 flex justify-end">
              <button type="button" id="cancelModalBtn" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
              <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-800 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-700">Save Tip</button>
          </div>
      </form>
  </div>
</div>

<!-- Edit Tip Modal -->
<div id="editTipModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Edit Tip</h3>
        <button id="closeEditModalBtn" type="button" class="text-2xl font-bold text-red-600 hover:text-red-800 p-1 leading-none transform hover:scale-110 transition-transform">&times;</button>
    </div>

      <form id="editTipForm" method="POST"> {# Action URL set by JS #}
          {% csrf_token %}
          <input type="hidden" id="editModalTipDate" name="date">

          <!-- TipForm fields will be populated by JS -->
          <div class="mb-4">
              <label for="editModalTipAmount" class="block text-sm font-medium text-gray-700">Tips:</label> 
              <input type="number" step="0.01" name="amount" id="editModalTipAmount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          </div>
          <div class="mb-4">
              <label for="editModalTipGratuity" class="block text-sm font-medium text-gray-700">Gratuity:</label> 
              <input type="number" step="0.01" name="gratuity" id="editModalTipGratuity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          </div>

          <!-- START: New Fields for Edit Modal -->
          <div class="mb-4">
              <label for="editModalCashMade" class="block text-sm font-medium text-gray-700">Cash:</label>
              <input type="number" step="0.01" name="cash_made" id="editModalCashMade" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          </div>
          <div class="mb-4">
              <label for="editModalHoursWorked" class="block text-sm font-medium text-gray-700">Hours:</label>
              <input type="number" step="0.25" name="hours_worked" id="editModalHoursWorked" placeholder="0.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          </div>
          <!-- END: New Fields for Edit Modal -->

          <div class="mb-4">
              <label for="editModalTipNote" class="block text-sm font-medium text-gray-700">Note (Optional)</label>
              <textarea name="note" id="editModalTipNote" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
          </div>

          <div class="mt-6 flex justify-between items-center">
              <a href="#" id="deleteTipLink" class="text-red-600 hover:text-red-800 text-sm">Delete Tip</a> {# Href set by JS #}

            <div>
                <button type="button" id="openNewShiftModalBtn" class="mr-1 py-1 px-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">New Shift</button>
                <button type="submit" id="saveChangesEditBtn" class="py-1 px-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-800 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-700">Save Changes</button>
            </div>
          </div>
      </form>
  </div>
</div>

<!-- Edit Pay Cycle Modal -->
<!-- START: Add New Shift Modal -->
<div id="addNewShiftModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-60"> 
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">New Shift</h3>
            <button id="closeAddNewShiftModalBtn" type="button" class="text-2xl font-bold text-red-600 hover:text-red-800 p-1 leading-none transform hover:scale-110 transition-transform">&times;</button>
        </div>
  
        <form id="addNewShiftForm"> 
            {% csrf_token %} 
            
            <p class="text-sm text-gray-600 mb-3">Enter the amounts for the additional shift. These will be added to the tips in your first shift.</p>
  
            <div class="mb-4">
                <label for="newShiftAmount" class="block text-sm font-medium text-gray-700">Tips:</label>
                <input type="number" step="0.01" name="amount" id="newShiftAmount" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
            </div>
            <div class="mb-4">
                <label for="newShiftGratuity" class="block text-sm font-medium text-gray-700">Gratuity:</label>
                <input type="number" step="0.01" name="gratuity" id="newShiftGratuity" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
            </div>
            <div class="mb-4">
                <label for="newShiftCashMade" class="block text-sm font-medium text-gray-700">Cash:</label>
                <input type="number" step="0.01" name="cash_made" id="newShiftCashMade" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
            </div>
            <div class="mb-4">
                <label for="newShiftHoursWorked" class="block text-sm font-medium text-gray-700">Hours:</label>
                <input type="number" step="0.25" name="hours_worked" id="newShiftHoursWorked" placeholder="0.0" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500">
            </div>
            <div class="mb-4">
                <label for="newShiftNote" class="block text-sm font-medium text-gray-700">Note for this shift (Optional)</label>
                <textarea name="note" id="newShiftNote" rows="2" class="mt-1 block w-full px-3 py-2 bg-white rounded-lg border-2 border-gray-400 text-gray-900 shadow-sm focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 placeholder-gray-500"></textarea>
            </div>
  
            <div class="mt-6 flex justify-end">
                <button type="button" id="cancelAddNewShiftBtn" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                <button type="submit" id="saveNewShiftBtn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Add Shift</button>
            </div>
        </form>
    </div>
  </div>
  <!-- END: Add New Shift Modal -->
    
  
<div id="editPayCycleModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
      <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Set Pay Cycle</h3>
          <button id="closePayCycleModalBtn" type="button" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>


      <form id="editPayCycleForm" method="POST" action="{% url 'set_pay_cycle' %}">
          {% csrf_token %}

          <div class="mb-4">
              <label for="payCycleStartDate" class="block text-sm font-medium text-gray-700">Pay Cycle Start Date</label>

              <input type="date" name="start_date" id="payCycleStartDate" required
                  value="{{ paycheck_cycle.start_date|date:'Y-m-d'|default:'' }}"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <p class="mt-1 text-xs text-gray-500">Select the starting date of your pay cycle.</p>
          </div>

          <div class="mt-6 flex justify-end">
              <button type="button" id="cancelPayCycleModalBtn" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
              <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-800 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-700">Save Settings</button>
          </div>
      </form>
  </div>
</div>

<!-- Confirm Delete Tip Modal -->
<div id="confirmDeleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-gray-800">
      <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Confirm Deletion</h3>
          <button id="closeConfirmDeleteModalBtn" type="button" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>

      <div class="mb-6">
          <p class="text-sm text-gray-700">Are you sure you want to permanently delete this tip?</p>
          <p class="text-sm text-red-600 font-medium">This action cannot be undone.</p>
      </div>

      <div class="mt-6 flex justify-end">
          <button type="button" id="cancelDeleteBtn" class="mr-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Cancel
          </button>
          <button type="button" id="confirmDeleteBtn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
              Delete Tip
          </button>
          <input type="hidden" id="confirmDeleteUrl">
      </div>
  </div>
</div>

{% endblock %} {# End of content block #}


{% block javascript %} {# Start of javascript block #}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Get Add Tip Modal elements ---
    const modal = document.getElementById('addTipModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const modalTipDateInput = document.getElementById('modalTipDate');
    const addTipForm = document.getElementById('addTipForm');
    // Get new add form inputs (optional, only needed if you want to manipulate them directly)
    // const modalCashMadeInput = document.getElementById('modalCashMade');
    // const modalHoursWorkedInput = document.getElementById('modalHoursWorked');
    // const modalTipNoteInput = document.getElementById('modalTipNote'); // Added note field

    // --- Function to open the Add Tip modal ---
    function openModal(date) {
      if (!modal || !modalTipDateInput || !addTipForm) return;
      modalTipDateInput.value = date;
      modal.classList.remove('hidden');
      addTipForm.reset(); // Resets all fields including new ones
      // Optionally set default focus
      const amountInput = document.getElementById('modalTipAmount');
      if (amountInput) amountInput.focus();
    }

    // --- Function to close the Add Tip modal ---
    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
    }

    // --- Event listeners for closing the Add Tip modal ---
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeModal);
    }
    if (cancelModalBtn) {
      cancelModalBtn.addEventListener('click', closeModal);
    }
    if (modal) {
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    // --- Handle Add Tip Form Submission via AJAX ---
    if (addTipForm) {
      addTipForm.addEventListener('submit', (event) => {
        event.preventDefault();

        // FormData automatically picks up all named fields, including the new ones
        const formData = new FormData(addTipForm);
        const url = addTipForm.action;
        const csrfTokenInput = addTipForm.querySelector('input[name="csrfmiddlewaretoken"]');

        if (!csrfTokenInput) {
            console.error('CSRF token input not found!');
            alert('Error: Could not submit form. Security token missing.');
            return;
        }
        const csrfToken = csrfTokenInput.value;

        const submitButton = addTipForm.querySelector('button[type="submit"]');
        if (submitButton) submitButton.disabled = true;

        fetch(url, {
          method: 'POST',
          body: formData, // Includes date, amount, gratuity, cash_made, hours_worked, note
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 400) {
                    return response.json().then(data => {
                        // Pass the errors object which might contain validation errors for new fields
                        throw { validationErrors: data.errors };
                    });
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            closeModal();
            location.reload(); // Reload to see the updated calendar/totals
          } else {
            alert(data.message || 'An unexpected error occurred.');
            console.error('Server indicated failure:', data);
          }
        })
        .catch(error => {
          console.error('Error submitting form:', error);
          if (error.validationErrors) {
            let errorMessages = "Please correct the following errors:\n";
            // Display validation errors for all fields, including new ones
            for (const field in error.validationErrors) {
              errorMessages += `\n${field}: ${error.validationErrors[field].join(', ')}`;
            }
            alert(errorMessages);
          } else {
            alert('Could not save tip. Please check your connection and try again.');
          }
        })
        .finally(() => {
            if (submitButton) submitButton.disabled = false;
        });
      });
    } else {
        console.error('Add tip form not found.');
    }

    // --- Get Edit Modal Elements ---
    const editModal = document.getElementById('editTipModal');
    const closeEditModalBtn = document.getElementById('closeEditModalBtn'); 
    const openNewShiftModalBtn = document.getElementById('openNewShiftModalBtn');
    const editTipForm = document.getElementById('editTipForm');
    const editModalTipDateInput = document.getElementById('editModalTipDate');
    const editModalTipAmountInput = document.getElementById('editModalTipAmount');
    const editModalTipGratuityInput = document.getElementById('editModalTipGratuity');
    const editModalTipNoteInput = document.getElementById('editModalTipNote');
    const deleteTipLink = document.getElementById('deleteTipLink');
    // START: Get new edit form inputs
    const editModalCashMadeInput = document.getElementById('editModalCashMade');
    const editModalHoursWorkedInput = document.getElementById('editModalHoursWorked');
    // END: Get new edit form inputs

    // --- Get Add New Shift Modal Elements ---
    const addNewShiftModal = document.getElementById('addNewShiftModal');
    const closeAddNewShiftModalBtn = document.getElementById('closeAddNewShiftModalBtn');
    const cancelAddNewShiftBtn = document.getElementById('cancelAddNewShiftBtn');
    const addNewShiftForm = document.getElementById('addNewShiftForm');
    const newShiftAmountInput = document.getElementById('newShiftAmount');
    const newShiftGratuityInput = document.getElementById('newShiftGratuity');
    const newShiftCashMadeInput = document.getElementById('newShiftCashMade');
    const newShiftHoursWorkedInput = document.getElementById('newShiftHoursWorked');
    const newShiftNoteInput = document.getElementById('newShiftNote');
    const saveNewShiftBtn = document.getElementById('saveNewShiftBtn');
    let originalEditTipData = null;
    // --- Function to open the Edit Modal ---
    function openEditModal(tipData) {
        // Ensure all required elements exist, including the new ones
        if (!editModal || !editTipForm || !deleteTipLink || !editModalCashMadeInput || !editModalHoursWorkedInput) {
            console.error("One or more edit modal elements not found!");
            return;
        }

        originalEditTipData = JSON.parse(JSON.stringify(tipData))

        let datePart = tipData.date;
        if (datePart && datePart.includes('T')) { // Handle potential datetime format from JSON
            datePart = datePart.split('T')[0];
        }
        editModalTipDateInput.value = datePart;
        editModalTipAmountInput.value = tipData.amount;
        editModalTipGratuityInput.value = tipData.gratuity != null ? tipData.gratuity : ''; 

        // START: Populate new fields
        // Ensure your backend view sends these fields in the JSON response!
        editModalCashMadeInput.value = tipData.cash_made != null ? tipData.cash_made : '';
        editModalHoursWorkedInput.value = tipData.hours_worked != null ? tipData.hours_worked : '';
        editModalTipNoteInput.value = tipData.note || ''; // Handle null/undefined - moved here for consistency
        // END: Populate new fields

        const editUrl = `/edit-tip/${tipData.id}/`; // Make sure this URL pattern exists in urls.py
        editTipForm.action = editUrl;

        const deleteUrl = `/delete-tip/${tipData.id}/`; // Make sure this URL pattern exists in urls.py
        deleteTipLink.href = deleteUrl; // Set href for the delete link

        editModal.classList.remove('hidden');
        // Optionally set focus
        if (editModalTipAmountInput) editModalTipAmountInput.focus();
    }

    // --- Function to close the Edit Modal ---
    function closeEditModal() {
        if (!editModal) return;
        originalEditTipData = null;
        editModal.classList.add('hidden');
    }

    // --- Add event listeners for closing the Edit Modal ---
    if (closeEditModalBtn) {
        closeEditModalBtn.addEventListener('click', closeEditModal);
    }
    // Note: The old cancelEditModalBtn listener is implicitly removed as the button ID changed or the button itself was repurposed.
    if (editModal) {
        editModal.addEventListener('click', (event) => {
        if (event.target === editModal) {
            closeEditModal();
        }
        });
    }

    // --- Handle "Save Changes" Form Submission via AJAX ---
    if (editTipForm) {
        editTipForm.addEventListener('submit', (event) => {
            event.preventDefault();

            
            // This is for the "Save Changes" button (id="saveChangesEditBtn", type="submit")
            const formData = new FormData(editTipForm);
            const url = editTipForm.action;
            const csrfTokenInput = editTipForm.querySelector('input[name="csrfmiddlewaretoken"]');

            if (!csrfTokenInput) {
                console.error('CSRF token input not found in edit form!');
                alert('Error: Could not submit form. Security token missing.');
                return;
            }
            const csrfToken = csrfTokenInput.value;

            const submitButton = document.getElementById('saveChangesEditBtn');
            if (submitButton) submitButton.disabled = true;

            fetch(url, {
                method: 'POST',
                body: formData, // Includes date, amount, gratuity, cash_made, hours_worked, note
                headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 400) {
                        return response.json().then(data => {
                            // Pass the errors object which might contain validation errors for new fields
                            throw { validationErrors: data.errors };
                        });
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                closeEditModal();
                location.reload(); // Reload to see updated calendar/totals
                } else {
                alert(data.message || 'An unexpected error occurred while saving.');
                console.error('Server indicated failure:', data);
                }
            })
            .catch(error => {
                console.error('Error submitting edit form:', error);
                if (error.validationErrors) {
                let errorMessages = "Please correct the following errors:\n";
                 // Display validation errors for all fields, including new ones
                for (const field in error.validationErrors) {
                    errorMessages += `\n${field}: ${error.validationErrors[field].join(', ')}`;
                }
                alert(errorMessages);
                } else {
                alert('Could not save changes. Please check your connection and try again.');
                }
            })
            .finally(() => {
                if (submitButton) submitButton.disabled = false;
            });
        });
    } else {
        console.error('Edit tip form not found.');
    }

    // --- Function to open the Add New Shift Modal ---
    function openAddNewShiftModal() {
        if (!addNewShiftModal || !editModal) return;
        addNewShiftForm.reset(); // Clear previous entries
        editModal.classList.add('hidden'); // Hide the edit modal
        addNewShiftModal.classList.remove('hidden');
        if(newShiftAmountInput) newShiftAmountInput.focus();
    }

    // --- Function to close the Add New Shift Modal ---
    function closeAddNewShiftModal() {
        if (!addNewShiftModal || !editModal) return;
        addNewShiftModal.classList.add('hidden');
        if (originalEditTipData) { // Only re-show edit modal if it was meant to be open
            editModal.classList.remove('hidden'); 
        }
    }

    // --- Event listener for "New Shift" button in Edit Modal ---
    if (openNewShiftModalBtn) {
        openNewShiftModalBtn.addEventListener('click', () => {
            if (!originalEditTipData) {
                alert('Error: Original tip data not found. Please reopen the edit window.');
                console.error('originalEditTipData is null when trying to open new shift modal.');
                return;
            }
            openAddNewShiftModal();
        });
    }

    // --- Event listeners for closing the Add New Shift Modal ---
    if (closeAddNewShiftModalBtn) {
        closeAddNewShiftModalBtn.addEventListener('click', closeAddNewShiftModal);
    }
    if (cancelAddNewShiftBtn) {
        cancelAddNewShiftBtn.addEventListener('click', closeAddNewShiftModal);
    }
    if (addNewShiftModal) {
        addNewShiftModal.addEventListener('click', (event) => {
            if (event.target === addNewShiftModal) {
                closeAddNewShiftModal();
            }
        });
    }

    // --- Handle "Add New Shift" Form Submission ---
    if (addNewShiftForm) {
        addNewShiftForm.addEventListener('submit', (event) => {
            event.preventDefault();

            if (!originalEditTipData) {
                alert('Error: Original tip data is missing. Cannot save new shift.');
                closeAddNewShiftModal(); // Close this modal
                // editModal might still be hidden, or user might be confused.
                // Consider if editModal should be re-shown or if an error forces a full modal close.
                return;
            }
            
            const csrfTokenInput = editTipForm.querySelector('input[name="csrfmiddlewaretoken"]'); // Get token from main edit form
            if (!csrfTokenInput) {
                console.error('CSRF token input not found in edit form for Add New Shift!');
                alert('Error: Could not submit form. Security token missing.');
                return;
            }
            const csrfToken = csrfTokenInput.value;
            const url = editTipForm.action; // Use the same URL as edit

            const additionalAmount = parseFloat(newShiftAmountInput.value) || 0;
            const additionalGratuity = parseFloat(newShiftGratuityInput.value) || 0;
            const additionalCash = parseFloat(newShiftCashMadeInput.value) || 0;
            const additionalHours = parseFloat(newShiftHoursWorkedInput.value) || 0;
            const additionalNote = newShiftNoteInput.value.trim();
            
            const totalAmount = (parseFloat(originalEditTipData.amount) || 0) + additionalAmount;
            const totalGratuity = (parseFloat(originalEditTipData.gratuity) || 0) + additionalGratuity;
            const totalCash = (parseFloat(originalEditTipData.cash_made) || 0) + additionalCash;
            const totalHours = (parseFloat(originalEditTipData.hours_worked) || 0) + additionalHours;

            let combinedNote = originalEditTipData.note || "";
            if (additionalNote) {
                if (combinedNote) {
                    combinedNote += "\n--- Second Shift ---\n" + additionalNote;
                } else {
                    combinedNote = "--- Second Shift ---\n" + additionalNote;
                }
            }
            const date = originalEditTipData.date.split('T')[0]; 

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken); // Add CSRF token to FormData
            formData.append('date', date);
            formData.append('amount', totalAmount.toFixed(2));
            formData.append('gratuity', totalGratuity.toFixed(2));
            formData.append('cash_made', totalCash.toFixed(2));
            formData.append('hours_worked', totalHours.toFixed(2));
            formData.append('note', combinedNote);

            if(saveNewShiftBtn) saveNewShiftBtn.disabled = true;

            fetch(url, {
                method: 'POST',
                body: formData, // CSRF token is now part of formData
                headers: {
                    // 'X-CSRFToken': csrfToken, // No longer needed here if in FormData
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 400) {
                        return response.json().then(data => { throw { validationErrors: data.errors }; });
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    addNewShiftModal.classList.add('hidden'); // Close new shift modal
                    closeEditModal(); // This closes edit modal and clears originalEditTipData
                    location.reload();
                } else {
                    alert(data.message || 'An unexpected error occurred while saving new shift data.');
                }
            })
            .catch(error => {
                console.error('Error submitting new shift data:', error);
                alert(error.validationErrors ? `Please correct errors: ${JSON.stringify(error.validationErrors)}` : 'Could not save new shift data. Please try again.');
            })
            .finally(() => {
                if(saveNewShiftBtn) saveNewShiftBtn.disabled = false;
            });
        });
    }

    // --- Get Confirm Delete Modal Elements ---
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const closeConfirmDeleteModalBtn = document.getElementById('closeConfirmDeleteModalBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const confirmDeleteUrlInput = document.getElementById('confirmDeleteUrl');

    // --- Function to open the Confirm Delete Modal ---
    function openConfirmDeleteModal(url) {
        if (!confirmDeleteModal || !confirmDeleteUrlInput) return;
        confirmDeleteUrlInput.value = url;
        confirmDeleteModal.classList.remove('hidden');
    }

    // --- Function to close the Confirm Delete Modal ---
    function closeConfirmDeleteModal() {
        if (!confirmDeleteModal || !confirmDeleteUrlInput) return;
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteUrlInput.value = '';
    }

    // --- Event listeners for closing the Confirm Delete modal ---
    if (closeConfirmDeleteModalBtn) {
        closeConfirmDeleteModalBtn.addEventListener('click', closeConfirmDeleteModal);
    }
    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', closeConfirmDeleteModal);
    }
    if (confirmDeleteModal) {
        confirmDeleteModal.addEventListener('click', (event) => {
            if (event.target === confirmDeleteModal) {
                closeConfirmDeleteModal();
            }
        });
    }

    // --- Handle Delete Tip Link Click (Opens Confirmation Modal) ---
    if (deleteTipLink) {
        deleteTipLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent navigating away
            const url = deleteTipLink.href; // Get URL set by openEditModal
            if (url && url !== '#') { // Check if URL is valid
                openConfirmDeleteModal(url);
            } else {
                console.error('Could not get valid URL from delete link.');
                alert('Error preparing deletion. Please try opening the edit modal again.');
            }
        });
    } else {
        console.error('Delete tip link not found.');
    }

    // --- Handle Actual Deletion from Confirmation Modal ---
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', () => {
            const url = confirmDeleteUrlInput.value;
            // Get CSRF token from the *edit* form as it's likely available
            const csrfTokenInput = editTipForm.querySelector('input[name="csrfmiddlewaretoken"]');

            if (!url) {
                console.error('No delete URL found in confirmation modal.');
                alert('Error: Could not determine which tip to delete.');
                closeConfirmDeleteModal();
                return;
            }
            if (!csrfTokenInput) {
                console.error('CSRF token input not found in edit form for deletion!');
                alert('Error: Could not delete tip. Security token missing.');
                closeConfirmDeleteModal();
                return;
            }
            const csrfToken = csrfTokenInput.value;

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Deleting...';

            fetch(url, {
                method: 'DELETE', // Use DELETE method for deletion
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json' // Expect JSON response
                },
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error message from JSON response
                    return response.json().then(errData => {
                        throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                    }).catch(() => {
                        // Fallback if response is not JSON or has no message
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    closeConfirmDeleteModal();
                    closeEditModal(); // Close the edit modal too
                    location.reload(); // Reload to reflect deletion
                } else {
                    console.error('Server indicated deletion failure:', data);
                    alert(data.message || 'An unexpected error occurred while deleting.');
                }
            })
            .catch(error => {
                console.error('Fetch failed completely during delete:', error);
                alert(`Could not delete tip: ${error.message}`);
            })
            .finally(() => {
                 // Ensure button is re-enabled and text reset even if modal closed early
                 confirmDeleteBtn.disabled = false;
                 confirmDeleteBtn.textContent = 'Delete Tip';
                 // Ensure modal is closed if still open
                 if (confirmDeleteModal && !confirmDeleteModal.classList.contains('hidden')) {
                     closeConfirmDeleteModal();
                 }
            });
        });
    } else {
        console.error('Confirm delete button not found.');
    }

    // --- Event Delegation on Calendar Grid (Handles BOTH Add and Edit) ---
    const calendarGrid = document.querySelector('.grid.grid-cols-7.sm\\:grid-cols-7');
    if (calendarGrid) {
        calendarGrid.addEventListener('click', (event) => {
            const addButton = event.target.closest('.add-tip-button');
            const editButton = event.target.closest('.edit-tip-button');

            if (addButton) {
                event.preventDefault(); // Prevent default link navigation
                const date = addButton.dataset.date;
                if (date) {
                    openModal(date); // Open the Add Tip modal
                } else {
                    console.error('Could not find date on add button.');
                }
            } else if (editButton) {
                event.preventDefault(); // Prevent default link navigation
                const tipId = editButton.dataset.tipId;
                if (tipId) {
                    // Fetch tip data for the edit modal
                    fetch(`/edit-tip/${tipId}/`, { // Use the same URL pattern as the form action
                        method: 'GET', // Use GET to fetch data
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest', // Indicate AJAX request
                            'Accept': 'application/json' // Expect JSON response
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // IMPORTANT: Ensure your view returns JSON like: {'tip': {'id': ..., 'amount': ..., 'cash_made': ..., 'hours_worked': ...}}
                        if (data.tip) {
                            openEditModal(data.tip); // Open the Edit Tip modal with fetched data
                        } else {
                            console.error('Tip data not found in response:', data);
                            alert('Error: Could not load tip details.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching tip data:', error);
                        alert('Error: Could not load tip details. Please try again.');
                    });
                } else {
                    console.error('Could not find tip ID on edit button.');
                }
            }
        });
    } else {
        console.error('Calendar grid container not found for event delegation.');
    }

    // --- Get Pay Cycle Modal Elements ---
    const payCycleModal = document.getElementById('editPayCycleModal');
    const openPayCycleBtn = document.getElementById('openPayCycleModalBtn');
    const closePayCycleBtn = document.getElementById('closePayCycleModalBtn');
    const cancelPayCycleBtn = document.getElementById('cancelPayCycleModalBtn');
    const payCycleForm = document.getElementById('editPayCycleForm');
    const payCycleStartDateInput = document.getElementById('payCycleStartDate');

    // --- Function to open the Pay Cycle Modal ---
    function openPayCycleModal() {
        if (!payCycleModal) return;
        payCycleModal.classList.remove('hidden');
        if (payCycleStartDateInput) payCycleStartDateInput.focus();
    }

    // --- Function to close the Pay Cycle Modal ---
    function closePayCycleModal() {
        if (!payCycleModal) return;
        payCycleModal.classList.add('hidden');
    }

    // --- Event Listeners for Pay Cycle Modal ---
    if (openPayCycleBtn) {
        openPayCycleBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent any default button action
            openPayCycleModal();
        });
    } else {
        console.error('Open Pay Cycle Modal button not found.');
    }

    if (closePayCycleBtn) {
        closePayCycleBtn.addEventListener('click', closePayCycleModal);
    }
    if (cancelPayCycleBtn) {
        cancelPayCycleBtn.addEventListener('click', closePayCycleModal);
    }
    if (payCycleModal) {
        payCycleModal.addEventListener('click', (event) => {
            if (event.target === payCycleModal) {
                closePayCycleModal();
            }
        });
    }

    // --- Handle Pay Cycle Form Submission via AJAX ---
    if (payCycleForm) {
        payCycleForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const formData = new FormData(payCycleForm);
            const url = payCycleForm.action;
            const csrfTokenInput = payCycleForm.querySelector('input[name="csrfmiddlewaretoken"]');

            if (!csrfTokenInput) {
                console.error('CSRF token input not found in pay cycle form!');
                alert('Error: Could not submit form. Security token missing.');
                return;
            }
            const csrfToken = csrfTokenInput.value;

            const submitButton = payCycleForm.querySelector('button[type="submit"]');
            if (submitButton) submitButton.disabled = true;

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 400) {
                        return response.json().then(data => {
                            // Handle potential validation errors from the backend
                            throw { validationErrors: data.errors || {'_error': ['Validation failed. Please check the fields.']} };
                        });
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    closePayCycleModal();
                    location.reload(); // Reload to update paycheck estimate
                } else {
                    alert(data.message || 'An unexpected error occurred.');
                    console.error('Server indicated failure:', data);
                }
            })
            .catch(error => {
                console.error('Error submitting pay cycle form:', error);
                if (error.validationErrors) {
                    let errorMessages = "Please correct the following errors:\n";
                    for (const field in error.validationErrors) {
                        const prefix = field === '_error' ? '' : `${field}: `; // Handle non-field errors
                        errorMessages += `\n${prefix}${error.validationErrors[field].join(', ')}`;
                    }
                    alert(errorMessages);
                } else {
                    alert('Could not save pay cycle settings. Please check your connection and try again.');
                }
            })
            .finally(() => {
                if (submitButton) submitButton.disabled = false;
            });
        });
    } else {
        console.error('Edit pay cycle form not found.');
    }
    // --- END OF PAY CYCLE MODAL JS ---

    // Close modals on Escape key press
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            if (modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
            if (editModal && !editModal.classList.contains('hidden')) {
                closeEditModal();
            }
            if (confirmDeleteModal && !confirmDeleteModal.classList.contains('hidden')) {
                closeConfirmDeleteModal();
            }
            if (payCycleModal && !payCycleModal.classList.contains('hidden')) {
                closePayCycleModal();
            }
            if (addNewShiftModal && !addNewShiftModal.classList.contains('hidden')) {
                closeAddNewShiftModal(); 
            }
        }
    });

  });
</script>
{% endblock %}
