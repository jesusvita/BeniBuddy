{% extends 'base.html' %}
{% load expense_tags %} {# Make sure you have the 'get_item' custom filter #}
{% load static %}

{% block title %}Expense Tracker - {{ current_month_name }} {{ current_year }}{% endblock %}

{% block content %}
<div class="rounded min-h-screen px-1 py-6 bg-gradient-to-b from-neutral-950 to-stone-900 text-white">

  <!-- Header Navigation -->
  <div class="flex flex-wrap px-4 sm:px-8 justify-between items-center gap-2 mb-4">

    <!-- Previous -->
    <a href="{% url 'expenses:expense_tracker' year=prev_month_year month=prev_month_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">
        <span class="hidden sm:inline">← Previous</span>
        <span class="inline sm:hidden">←</span>
    </a>

    <!-- Month & Totals -->
    <div class="text-center">
      <h2 class="text-2xl font-bold text-lightPink ">{{ current_month_name }} {{ current_year }}</h2>
      <div class="text-sm">
        <span class="text-red-300 font-medium">Total Expenses: ${{ total_monthly_expenses|floatformat:2 }}</span>
      </div>
    </div>

    <!-- Next -->
    <a href="{% url 'expenses:expense_tracker' year=next_month_year month=next_month_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">
       <span class="hidden sm:inline">Next →</span>
        <span class="inline sm:hidden">→</span>
    </a>
  </div>

  <!-- Weekday Labels -->
  <div class="grid grid-cols-7 text-center font-semibold text-[#93A8AC] mb-2">
    {# Adjust to match your user_tips.html if it starts on a different day, e.g., Mon #}
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
    <div>Thu</div><div>Fri</div><div>Sat</div>
  </div>

  <!-- Calendar Grid -->
  <div class="grid grid-cols-7 sm:grid-cols-7 gap-x-1 gap-y-2 text-sm md:gap-2">
    {% for week in month_days %}
      {% for day_date in week %}
        <div class="relative transition-transform duration-150 hover:scale-[1.03]">
          {% if day_date.month == current_month_numeric %}
            {# This div is clickable to open the expense modal #}
            <div class="calendar-day block h-14 sm:h-16 rounded-lg shadow hover:bg-gray-100 transition cursor-pointer
                        {% if day_date == today_date %} bg-primary text-paleWhite hover:bg-primary-dark {% else %} bg-white text-gray-700 hover:bg-gray-50 {% endif %}"
                 data-date="{{ day_date|date:'Y-m-d' }}">
              <!-- Date Number -->
              <div class="absolute px-1 text-[0.6rem] sm:text-xs font-semibold {% if day_date == today_date %} text-paleWhite {% else %} text-gray-700 {% endif %}">{{ day_date.day }}</div>

              <!-- Expense Info -->
              <div class="flex flex-col justify-center items-end h-full font-semibold pt-3 px-1 sm:pt-1">
                {% with day_expenses_list=expenses_by_day|get_item:day_date.day %}
                  {% if day_expenses_list %}
                    {% for expense_item in day_expenses_list|slice:":2" %} {# Show first 2 expense amounts #}
                      <div class="font-sans font-[700] text-red-700 text-[0.5rem] sm:text-[0.65rem] leading-tight sm:leading-normal tabular-nums"
                           title="{{ expense_item.name }}: ${{ expense_item.amount|floatformat:2 }}">
                          ${{ expense_item.amount|floatformat:2 }}
                      </div>
                    {% endfor %}
                    {% if day_expenses_list|length > 2 %}
                      <div class="text-red-500 text-xs">...</div>
                    {% endif %}
                  {% else %}
                     <div class="text-xs text-gray-400 italic"></div> {# Placeholder if no expenses #}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          {% else %}
            <!-- Empty box for days not in current month -->
            <div class="h-14 sm:h-16 rounded-lg bg-[#93A8AC] opacity-30"></div>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  </div>
</div>

<!-- Expense Modal (ensure this matches your previously designed expense modal) -->
<div id="expense-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-deepBlue p-6 rounded-lg shadow-xl w-full max-w-md"> {# Using your theme colors #}
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-paleWhite" id="modal-title">Manage Expenses</h3>
            <button id="close-modal-button" class="text-lightPink hover:text-primary text-2xl">&times;</button>
        </div>
        <form method="post" id="expense-form" novalidate>
            {% csrf_token %}
            <input type="hidden" name="expense_date_selected" id="expense-date-selected">

            <div class="mb-4">
                <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.category.label }}</label>
                {{ form.category }} {# Styled by widgets in forms.py #}
                {% if form.category.errors %}<div class="mt-1 text-red-400 text-xs">{{ form.category.errors|first }}</div>{% endif %}
            </div>
            <div class="mb-4">
                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.name.label }}</label>
                {{ form.name }} {# Assumes form.name widget has Tailwind classes from forms.py #}
                {% if form.name.errors %}<div class="mt-1 text-red-400 text-xs">{{ form.name.errors|first }}</div>{% endif %}
            </div>
            <div class="mb-6">
                <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.amount.label }}</label>
                {{ form.amount }} {# Assumes form.amount widget has Tailwind classes from forms.py #}
                {% if form.amount.errors %}<div class="mt-1 text-red-400 text-xs">{{ form.amount.errors|first }}</div>{% endif %}
            </div>
            <button type="submit"
                    class="w-full bg-primary hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-deepBlue focus:ring-primary transition-colors">
                Save Expense
            </button>
        </form>
        <!-- Display existing expenses for the day -->
        <div id="modal-existing-expenses" class="mt-6">
            <h4 class="text-lg font-semibold text-paleWhite mb-2">Recorded Expenses for <span id="modal-selected-date-display"></span>:</h4>
            <ul id="modal-expense-list" class="list-disc list-inside text-lightPink text-sm max-h-32 overflow-y-auto">
                <li id="modal-no-expenses-message" class="italic">No expenses for this day.</li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const expenseModal = document.getElementById('expense-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const expenseDateSelectedInput = document.getElementById('expense-date-selected');
    const modalTitle = document.getElementById('modal-title');
    const calendarDays = document.querySelectorAll('.calendar-day'); // Targets the clickable day divs
    const expenseForm = document.getElementById('expense-form');
    const firstFormInput = expenseForm ? expenseForm.querySelector('input[name="name"]') : null;

    const modalSelectedDateDisplay = document.getElementById('modal-selected-date-display');
    const modalExpenseList = document.getElementById('modal-expense-list');
    const modalNoExpensesMessage = document.getElementById('modal-no-expenses-message');

    // Parse the JSON data for expenses passed from the Django view
    const expensesByDayData = JSON.parse('{{ expenses_by_day_json_for_template|safe }}');

    calendarDays.forEach(dayCell => {
        dayCell.addEventListener('click', () => {
            const dateStr = dayCell.getAttribute('data-date');
            if (!dateStr) return; // Should not happen if data-date is always present

            expenseDateSelectedInput.value = dateStr;
            // Format date for display in modal title (e.g., "January 1, 2024")
            const dateObj = new Date(dateStr + 'T00:00:00'); // Ensure correct parsing by adding time part
            const formattedDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            modalTitle.textContent = `Manage Expenses for ${formattedDate}`;
            modalSelectedDateDisplay.textContent = formattedDate;

            // Populate existing expenses for the selected day in the modal
            modalExpenseList.innerHTML = ''; // Clear previous list items
            const dayOfMonthStr = dateObj.getDate().toString(); // Get day as string (1-31)
            const dailyExpenses = expensesByDayData[dayOfMonthStr] || [];

            if (dailyExpenses.length > 0) {
                if(modalNoExpensesMessage) modalNoExpensesMessage.classList.add('hidden');
                dailyExpenses.forEach(exp => {
                    const li = document.createElement('li');
                    li.textContent = `[${exp.category || 'Other'}] ${exp.name}: $${parseFloat(exp.amount).toFixed(2)}`;
                    modalExpenseList.appendChild(li);
                });
            } else {
                // Ensure the "no expenses" message is a child before trying to remove 'hidden'
                if (!modalExpenseList.contains(modalNoExpensesMessage) && modalNoExpensesMessage) {
                     modalExpenseList.appendChild(modalNoExpensesMessage);
                }
                if(modalNoExpensesMessage) modalNoExpensesMessage.classList.remove('hidden');
            }

            expenseModal.classList.remove('hidden');
            if (firstFormInput) {
                firstFormInput.focus();
            }
        });
    });

    if (closeModalButton) {
        closeModalButton.addEventListener('click', () => {
            expenseModal.classList.add('hidden');
            if (expenseForm) expenseForm.reset();
        });
    }

    if (expenseModal) {
        // Close modal if clicking outside of it
        expenseModal.addEventListener('click', (event) => {
            if (event.target === expenseModal) {
                expenseModal.classList.add('hidden');
                if (expenseForm) expenseForm.reset();
            }
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && expenseModal && !expenseModal.classList.contains('hidden')) {
            expenseModal.classList.add('hidden');
            if (expenseForm) expenseForm.reset();
        }
    });

    // If form has errors (e.g., after a failed POST), re-open modal with the data
    {% if form.errors %}
        const submittedDate = "{{ request.POST.expense_date_selected }}";
        if (submittedDate) {
            const dayCellToReopen = document.querySelector(`.calendar-day[data-date="${submittedDate}"]`);
            if (dayCellToReopen) {
                // Timeout to ensure other DOM manipulations (if any) are done
                setTimeout(() => { dayCellToReopen.click(); }, 0);
            }
        }
    {% endif %}
});
</script>
{% endblock %}