{% extends 'base.html' %}
{% load expense_tags %}
{% load static %}
{% load sum_filters %}

{% block title %}Expense Tracker - {{ current_month_name }} {{ current_year }}{% endblock %}

{% block content %}
<div class="rounded min-h-screen px-1 py-6 bg-gradient-to-b from-neutral-950 to-stone-900 text-white">

  <!-- Header Navigation -->
  <div class="flex flex-wrap px-4 sm:px-8 justify-between items-center gap-2 mb-4">
    <a href="{% url 'expenses:expense_tracker' year=prev_month_year month=prev_month_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">‚Üê Previous</a>

    <div class="text-center">
      <h2 class="text-2xl font-bold text-white">{{ current_month_name }} {{ current_year }}</h2>
    </div>

    <a href="{% url 'expenses:expense_tracker' year=next_month_year month=next_month_month %}"
       class="font-semibold py-0.5 px-2 sm:py-1 sm:px-4 rounded-full shadow transition hover:bg-red-900"
       style="background-color: #880808;">Next ‚Üí</a>
  </div>

  <!-- Weekdays -->
  <div class="grid grid-cols-7 text-center font-semibold text-[#93A8AC] mb-2">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>

  <!-- Calendar -->
  <div class="grid grid-cols-7 gap-x-1 gap-y-3 text-sm md:gap-2">
    {% for week in month_days %}
      {% for day_date in week %}
        <div class="relative transition-transform duration-150 hover:scale-[1.03]">
          {% if day_date.month == current_month_numeric %}
            <div class="calendar-day block h-14 sm:h-16 rounded-lg shadow hover:bg-gray-100 transition cursor-pointer
            {% if day_date == today_date %} bg-primary text-paleWhite hover:bg-primary-dark {% else %} bg-white text-gray-700 hover:bg-gray-50 {% endif %}"
     data-date="{{ day_date|date:'Y-m-d' }}">

          <div class="absolute px-1 text-[0.6rem] sm:text-xs font-semibold">{{ day_date.day }}</div>

          <div class="flex flex-col justify-center items-end h-full font-semibold pt-3 px-1 sm:pt-1">
            {% with day_expenses_list=expenses_by_day|get_item:day_date.day %}
              {% if day_expenses_list %}
                {% for expense_item in day_expenses_list|slice:":2" %}
                  <div class="font-sans font-[700] text-red-700 text-[0.5rem] sm:text-[0.65rem] leading-tight tabular-nums"
                      title="{{ expense_item.name }}: ${{ expense_item.amount|floatformat:2 }}">
                      ${{ expense_item.amount|floatformat:2 }}
                  </div>
                {% endfor %}
                {% if day_expenses_list|length > 2 %}
                  <div class="text-red-500 text-xs">...</div>
                {% endif %}
                <!-- Total amount for the day -->
                <div class="text-red-800 font-bold text-xs sm:text-sm mt-1" title="Total for the day">
                  Total: ${{ day_expenses_list|sum_attr:"amount"|floatformat:2 }}
                </div>
              {% endif %}
            {% endwith %}
          </div>
        </div>
          {% else %}
            <div class="h-14 sm:h-16 rounded-lg bg-[#93A8AC] opacity-30"></div>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- Monthly Summary -->
  <div class="text-center mt-6 px-4 sm:px-8 text-sm sm:text-base">
    <h3 class="text-xl font-semibold text-paleWhite mb-2">Monthly Summary</h3>
    <p class="text-red-300 font-bold text-lg mb-4">
      Total Monthly Expenses: ${{ total_monthly_expenses|floatformat:2 }}
    </p>
    {% if current_week_start_date_str %}
    <p class="text-softBlue font-semibold">
      Current Week (Week of {{ current_week_start_date_str }}): ${{ current_week_total|floatformat:2 }}
    </p>
    {% endif %}
  </div>
</div>

<!-- Manage Expenses Modal -->
<div id="expense-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
  <div class="bg-deepBlue p-6 rounded-lg shadow-xl w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-paleWhite" id="modal-title">Manage Expenses</h3>
      <button id="add-expense-button" class="ml-auto bg-primary hover:bg-red-700 text-white font-semibold py-1 px-3 rounded shadow-sm">+ Add</button>
      <button id="close-modal-button" class="text-lightPink hover:text-primary text-2xl ml-2">&times;</button>
    </div>

    <div id="modal-existing-expenses" class="mt-6">
      <ul id="modal-expense-list" class="list-disc list-inside text-lightPink text-sm max-h-40 overflow-y-auto">
        
        <!-- Example static structure for one expense item -->
        <li class="flex justify-between items-center py-1">
          <span class="truncate" title="Groceries: $25.00">Groceries - $25.00</span>
          <div class="flex gap-2 ml-2">
            <button class="edit-expense-btn text-primary hover:text-red-700" data-expense-id="123" aria-label="Edit Groceries expense">
              ‚úé
            </button>
            <button class="delete-expense-btn text-red-600 hover:text-red-800" data-expense-id="123" aria-label="Delete Groceries expense">
              üóë
            </button>
          </div>
        </li>
      </ul>

      </ul>
      <div id="modal-no-expenses-message" class="italic text-lightPink hidden">No expenses for this day.</div>
    </div>
  </div>
</div>

<!-- Add/Edit Expense Modal -->
<div id="expense-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
  <div class="bg-deepBlue p-6 rounded-lg shadow-xl w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-paleWhite" id="expense-form-modal-title">Add Expense</h3>
      <button id="close-expense-form-modal" class="text-lightPink hover:text-primary text-2xl">&times;</button>
    </div>

    <form method="post" id="expense-form" novalidate>
      {% csrf_token %}
      <input type="hidden" name="expense_date_selected" id="expense-date-selected">
      <input type="hidden" name="editing_expense_id" id="editing-expense-id">

      <div class="mb-4">
        <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.category.label }}</label>
        {{ form.category }}
      </div>
      <div class="mb-4">
        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.name.label }}</label>
        {{ form.name }}
      </div>
      <div class="mb-6">
        <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-lightPink mb-1">{{ form.amount.label }}</label>
        {{ form.amount }}
      </div>

      <button type="submit"
        class="w-full bg-primary hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition-colors">
        Save
      </button>
    </form>
  </div>
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}
{% load static %} {# Ensure static is loaded if not already in base.html or earlier in this block #}
<script>
  // Pass Django template data to global JavaScript variables
  window.expensesByDayData = JSON.parse('{{ expenses_by_day_json_for_template|safe }}');
  window.formFieldIds = {
    category: '{{ form.category.id_for_label }}',
    name: '{{ form.name.id_for_label }}',
    amount: '{{ form.amount.id_for_label }}'
  };

  // For handling re-opening modal on form errors
  {% if form.errors %}
    window.djangoFormErrors = true;
    window.submittedExpenseDate = "{{ request.POST.expense_date_selected|escapejs }}";
  {% else %}
    window.djangoFormErrors = false;
    window.submittedExpenseDate = null;
  {% endif %}
</script>
<script src="{% static 'expenses/js/expenses_calendar.js' %}"></script>
{% endblock %}
